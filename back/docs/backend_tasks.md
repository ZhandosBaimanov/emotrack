# Emotrack Backend — Оставшиеся задачи

Ниже — список незавершённых задач для бэкенда, сгруппированных по функциональным блокам, с примерными эндпоинтами, критериями готовности и техническими заметками.

## 1. Система тестирования

- [ ] CRUD для тестов
  - Эндпоинты: `GET /tests`, `POST /tests`, `GET /tests/{id}`, `PUT /tests/{id}`, `DELETE /tests/{id}`
  - Доступ: создание/редактирование/удаление — только психологи; просмотр — авторизованные пользователи
  - Критерии: валидация структуры теста, пагинация списка
- [ ] Модель теста с вопросами и вариантами ответов
  - Сущности: `Test`, `Question`, `AnswerOption`, связи (1:N, порядок вопросов)
  - Поддержка шкалирования ответов (баллы за вариант)
- [ ] Логика подсчёта результатов (PHQ-9, GAD-7)
  - Реализация агрегаторов по ключам вопросов и суммированию баллов
  - Интерпретация диапазонов (уровни тяжести)
- [ ] Эндпоинт для прохождения теста
  - `POST /tests/{id}/submit` — принимает ответы, рассчитывает результат, сохраняет
  - Ответ: итоговый балл, интерпретация, разложение по вопросам
- [ ] Сохранение результатов тестов пациента
  - Сущность: `TestResult` (user_id, test_id, дата, ответы, итог, интерпретация)
  - Доступ: пациент видит свои; психолог видит своих пациентов
- [ ] История пройденных тестов
  - Эндпоинты: `GET /tests/results/me`, `GET /tests/results/patient/{user_id}`
  - Фильтры: период, тип теста; пагинация

## 2. Образовательные ресурсы

- [ ] CRUD для ресурсов (создание — только психологи)
  - Эндпоинты: `GET /resources`, `POST /resources`, `GET /resources/{id}`, `PUT /resources/{id}`, `DELETE /resources/{id}`
  - Поля: заголовок, содержание (markdown/html), категория, теги, автор
- [ ] Категоризация и теги
  - Фильтры: `?category=...&tags=tag1,tag2`; индексы по категории/тегам
- [ ] Поиск/фильтрация по категориям/тегам/тексту
  - Полнотекстовый поиск (минимально — `ILIKE` по заголовку/контенту)
- [ ] Загрузка изображений (опционально)
  - Эндпоинт: `POST /resources/{id}/upload-image`
  - Хранение: файловая система/S3; валидация типа/размера
- [ ] Валидация URL для видео
  - Поле: `video_url`; проверка формата (YouTube/Vimeo, https)

## 3. Чат система

- [ ] Создание/получение чата между психологом и пациентом
  - Эндпоинты: `POST /chats` (создать связку), `GET /chats`, `GET /chats/{id}`
  - Правила: уникальность пары (психолог-пациент), проверка отношений
- [ ] Отправка сообщений
  - `POST /chats/{id}/messages` — текст, вложения (опционально)
  - Сущность: `Message` (chat_id, sender_id, content, created_at, read_at)
- [ ] Получение истории сообщений
  - `GET /chats/{id}/messages?skip=&limit=` — пагинация, сортировка
- [ ] Пометка сообщений как прочитанных
  - `POST /chats/{id}/messages/read` или `PATCH /messages/{id}/read`
- [ ] WebSocket для realtime (или polling)
  - `GET /ws/chats/{id}` — авторизация по JWT; событие: новое сообщение/прочтение
  - Fallback: `GET /chats/{id}/events` (long polling)
- [ ] Счётчик непрочитанных сообщений
  - `GET /chats/{id}/unread-count`, `GET /chats/unread-count` (по всем чатам)

## 4. Профили и управление

- [ ] Редактирование профиля пользователя
  - `PATCH /users/me` — имя, аватар (опц.), контакты
- [ ] Список пациентов для психолога
  - `GET /users/my-patients` — с пагинацией и базовой статистикой
- [ ] Статистика по пациенту
  - `GET /patients/{id}/stats` — динамика настроения, результаты тестов, активности
- [ ] Отключение связи пациент–психолог
  - `DELETE /relations/{patient_id}` — разрыв связи, аудит

## 5. Уведомления

- [ ] Система уведомлений о новых сообщениях
  - Триггеры: новые `Message`; каналы: in-app, (опц. email/push)
  - Эндпоинты: `GET /notifications`, `POST /notifications/read`
- [ ] Уведомления о новых ресурсах
  - Триггеры: новые `Resource` в подписанных категориях

## 6. Аналитика и визуализация

- [ ] Эндпоинты графиков настроения
  - `GET /analytics/mood?from=&to=&period=week|month`
- [ ] Агрегация по периодам
  - Серии по дням/неделям/месяцам; минимум/максимум/среднее
- [ ] Сравнительная статистика
  - Сравнение периодов, тестов, корреляции (базово)

## 7. OAuth интеграция

- [ ] Заглушка Google OAuth
  - Эндпоинты: `GET /auth/google/login`, `GET /auth/google/callback`
  - Хранение связки `oauth_provider`, `oauth_subject`, привязка к `User`

## 8. Админ функционал

- [ ] Модерация контента
  - `PATCH /resources/{id}/status` — модерация (approved/rejected)
- [ ] Управление пользователями
  - `GET /admin/users`, `PATCH /admin/users/{id}` (роль/статус)
- [ ] Логи и аудит
  - Запись ключевых действий: аутентификация, CRUD, сообщения, связи
  - Эндпоинт: `GET /admin/audit` (пагинация, фильтры)

## 9. Безопасность

- [ ] Rate limiting для критичных эндпоинтов
  - Кандидаты: логин, submit теста, сообщения; лимиты по IP/пользователю
- [ ] Валидация прав доступа (dependencies)
  - Декораторы/зависимости: `is_psychologist`, `is_admin`, владение ресурсом
- [ ] Логирование действий пользователей
  - Структурированные логи: пользователь, действие, метаданные, результат

## 10. Оптимизация

- [ ] Пагинация для всех списков
  - Единый контракт: `skip`, `limit`, `total` в ответах
- [ ] Кеширование часто запрашиваемых данных
  - Кандидаты: списки ресурсов, справочники, статистика за период
  - Инвалидация при изменениях
- [ ] Индексы в БД
  - Индексы: `messages(chat_id, created_at)`, `resources(category)`, `resources_tags(tag)`, `test_results(user_id, created_at)`

---

### Технические заметки

- Схемы и модели
  - Добавить Pydantic-схемы: `TestCreate/Update`, `Question`, `AnswerOption`, `TestSubmit`, `TestResult`
  - SQLAlchemy-модели: соответствующие сущности с внешними ключами и каскадами
- Авторизация и роли
  - Использовать текущую модель ролей; зависимости для проверки роли/владения
- Документация API
  - Описать эндпоинты в OpenAPI/Swagger через FastAPI
- Миграции
  - Создать Alembic-миграции для новых таблиц и индексов
- Производительность
  - Везде следить за N+1; использовать `selectinload`/`joinedload` по месту
